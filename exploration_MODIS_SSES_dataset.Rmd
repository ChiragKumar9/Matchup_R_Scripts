---
title: "Exploration of a MODIS SSES Dataset"
output:
  html_notebook:
    toc: True
    theme: united
---

# Prep Workspace and Data

```{r prep_workspace, echo=TRUE}
# Import necessary packages
require(ggplot2)
require(dplyr)
require(RColorBrewer)
require(circular)
require(ggmap)

ggplot <- function(...) {ggplot2::ggplot(...) + theme_bw()}

# Define secant function
secant.deg <- function(x) {1 / (cos(circular::rad(x)))}

# Source own functions
# Define direwctory where functions are for each operating system

if (Sys.info()["sysname"] == 'Windows') {
  fun.dir <- 'D:/matchups/r-projects/Matchup_R_Scripts/Functions/'
} else if (Sys.info()["sysname"] == 'Linux') {
  fun.dir <- '/home/ckk/Projects/Matchup_R_Scripts/Functions/'
}

fun.file <- paste0(fun.dir, 'common_functions.R')

source(file = fun.file,
  local = FALSE, echo = FALSE, verbose = FALSE)
rm(fun.dir, fun.file)


# Load data
# For 787
linux_dir <- '~/Projects/Matchup_R_Scripts/Results/objects/'
# For Laptop
#linux_dir <- '~/Projects/Matchup_R_Scripts/'
linux_file <- 'MODIS_Aqua_GSFC_ALL_Class_6.4.1_ao_2017_04_12_with_ancillary.Rdata'
AQUA_file <- paste0(linux_dir, linux_file)

if (!file.exists(AQUA_file)) {
    stop('Input file does not exist')
  } else {
    load(AQUA_file, verbose = TRUE)
    AQUA <- MODIS_Aqua_GSFC_ALL_Class_6.4.1_ao_2017_04_12
  }

rm(linux_dir, linux_file, AQUA_file)
rm(MODIS_Aqua_GSFC_ALL_Class_6.4.1_ao_2017_04_12)
```

```{r prep_data, echo=TRUE}
# Turn POSIXct objects to characters bc dplyr doesn't support POSIXct
AQUA$sat.timedate <- as.character(AQUA$sat.timedate)
AQUA$buoy.timedate <- as.character(AQUA$buoy.timedate)

# Apply basic filtering
AQUA <- dplyr::tbl_df(AQUA) %>%
  dplyr::filter(solz >= 90) %>%
  dplyr::filter(qsst == 0 | qsst == 1 | qsst == 2)

# Now grab only variables that may be used to determine retrieval accuracy and make some new variables (i.e. x1, x2, x3)
# Create df of features
orig <- dplyr::tbl_df(AQUA) %>%
  dplyr::mutate(x1 = cen.11000,
    x2 = cen.11000 - cen.12000,
    x3 = cen.ref.type.1.SST,
    satz = satz,
    x2 = x2 * x3,
    x3 = ((secant.deg(satz) - 1) * x2),
    SST.resid = buoy.sst - cen.sst,
    lat = buoy.lat,
    lon = buoy.lon,
    sd11 = sd.11000,
    sd12 = sd.12000,
    range11 = max.11000 - min.11000,
    range12 = max.12000 - min.12000,
    diff.med.min11 = med.11000 - min.11000,
    diff.med.min12 = med.12000 - min.12000,
    band.diff = cen.11000 - cen.12000,
    qsst = qsst,
    buoy.sst = buoy.sst,
    SST.resid = (buoy.sst + .17) - cen.sst) %>% 
  dplyr::select(x1, x2, x3, satz, lon, lat, sd11, sd12, range11, range12, diff.med.min11, diff.med.min12, band.diff, qsst, buoy.sst, SST.resid)

```


# Explore Data
## Residuals by Quality
```{r resid_spread_quality, echo=TRUE}
# First look at the resid spread among different quality levels
# qsst == 0
summary(orig$SST.resid[orig$qsst == 0])

# qsst == 1
summary(orig$SST.resid[orig$qsst == 1])

# qsst == 2
summary(orig$SST.resid[orig$qsst == 2])

```

## SST

```{r sst_resid_plot, echo=TRUE}
ccc <- RColorBrewer::brewer.pal(n = 8, name = 'YlOrRd')
ccc <- ccc[3:8]

ggplot2::ggplot(data = orig, aes(x = buoy.sst, y = SST.resid)) +
  geom_bin2d(bins = 100) + 
  scale_fill_gradientn(colours = ccc) +
  geom_abline(slope = 0, intercept = 0, col = 'cyan')

# Look at the statistics of the residuals
summary(orig$SST.resid)
IQR(orig$SST.resid)
```


## Location of Matchups

### Location of Whole Dataset

```{r spatial_distribution, echo=TRUE}
mp <- NULL
mapWorld <- borders("world", colour = "gray50", fill = "gray70") # create a layer of borders
mp <- ggplot() +  mapWorld +
  ggplot2::scale_x_continuous(breaks = seq(from = -180, to = 180, by = 60)) +
  ggplot2::scale_y_continuous(breaks = seq(from = -90, to = 90, by = 30)) +
  coord_fixed(ratio = 1)

# WARNING: Be careful as this worked with ggplot2 2.1.0 on Linux
# Try to work on different machines with varying versions of ggplot2
# Now layer the buoys on top with hexagonal binning
mp <- mp + 
  ggplot2::stat_binhex(data = orig,
    aes(x = buoy.lon, # Use hexagonal binning command and give x and y input
    y = buoy.lat,
    fill = cut(..count.., c(0, 100, 500, 1000, 1500, Inf))), # Divides matchups per bin into discrete chunks and colors likewise
    binwidth = c(10, 10)) +
  mapWorld + labs(x = NULL, y = NULL) +
  #scale_fill_hue('value') + # Standard colors with discrete chunking
  scale_fill_brewer(palette = 'YlOrRd') + # Change colors to Yellow, Orange, and Red - many diff 
  guides(fill = guide_legend(title = "N of matchups"))

#ggplot2::ggsave(filename = 'spatial_distribution.ps', device = 'ps',
#       width = 8, height = 6, units = 'in')

mp
```

### Residuals by Location

```{r, echo=TRUE}
proportion <- .2
random_indeces <- sample(1, nrow(orig), floor(proportion * nrow(orig)), replace = FALSE)
ttt <- orig[random_indeces, ]

ccc <- RColorBrewer::brewer.pal(n = 8, name = 'YlOrRd')
ccc <- ccc[3:8]

mp <- NULL
mapWorld <- borders("world", colour = "gray50", fill = "gray70") # create a layer of borders
mp <- ggplot() +  mapWorld +
  ggplot2::scale_x_continuous(breaks = seq(from = -180, to = 180, by = 60)) +
  ggplot2::scale_y_continuous(breaks = seq(from = -90, to = 90, by = 30)) +
  coord_fixed(ratio = 1)

# WARNING: Be careful as this worked with ggplot2 2.1.0 on Linux
# Try to work on different machines with varying versions of ggplot2
# Now layer the buoys on top with hexagonal binning
mp <- mp + 
  ggplot2::geom_point(data = ttt,
    aes(x = buoy.lon, 
    y = buoy.lat,
    col = SST.resid,
    pch = '.',
    alpha = 0.2)) +
  mapWorld + labs(x = NULL, y = NULL) +
  scale_fill_gadientn(colours = cc)
  guides(fill = guide_legend(title = "N of matchups"))

#ggplot2::ggsave(filename = 'spatial_distribution.ps', device = 'ps',
#       width = 8, height = 6, units = 'in')

mp
```

## 11 and 12 um Variables

### Residuals as a Function of Temperature Deficit

```{r resid_temp_deficit, echo=TRUE}
ggplot2::ggplot(data = orig, aes(x = x1, y = SST.resid, pch = '.', alpha = 0.2)) +
  geom_bin2d(bins = 100)
```

### Residuals as a Function of Band Difference

```{r resid_band_diff, echo=TRUE}
ggplot2::ggplot(data = orig, aes(x = band.diff, y = SST.resid, pch = '.', alpha = 0.2)) +
  geom_bin2d(bins = 100)
```

### Residuals as a Function of 11 um Range

```{r resid_range11, echo=TRUE}
ggplot2::ggplot(data = orig, aes(x = range11, y = SST.resid, pch = '.', alpha = 0.2)) + 
  geom_bin2d(bins = 100)
```


## satz
```{r resid_by_satz_intervals, echo=TRUE}
satz_intervals <- cut(abs(orig$satz), c(0, 10, 20, 30, 40, 50, 55))

ggplot2::ggplot(data = orig) +
  geom_histogram(SST.resid) +
  facet_wrap(~satz_intervals)

```


## x1, x2 and x3
We want to explore the feature space of x1, x2, and x3 and specifically the distribution of retrievals in this space and residuals in this space.
